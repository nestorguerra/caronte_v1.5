<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leo vs Los Reyes Magos - Pacman Style</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(180deg, #0a0a2e 0%, #1a0a3e 50%, #0a1a2e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
        }

        #gameContainer {
            position: relative;
            background: #000;
            border: 6px solid #ffd700;
            border-radius: 10px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.4);
            padding: 10px;
        }

        canvas {
            display: block;
            border-radius: 5px;
        }

        #startScreen, #gameOverScreen, #victoryScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10;
            border-radius: 5px;
        }

        #gameOverScreen, #victoryScreen {
            display: none;
        }

        h1 {
            font-size: 28px;
            color: #ffd700;
            text-shadow: 4px 4px #8b4513, 0 0 20px #ffd700;
            margin-bottom: 10px;
            text-align: center;
        }

        h2 {
            font-size: 14px;
            color: #ff6b6b;
            margin-bottom: 30px;
            text-align: center;
        }

        .kings-preview {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        .king-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            animation: bounce 0.5s infinite alternate;
        }

        .king-icon:nth-child(1) { background: #ff6b6b; animation-delay: 0s; }
        .king-icon:nth-child(2) { background: #4ecdc4; animation-delay: 0.1s; }
        .king-icon:nth-child(3) { background: #ffe66d; animation-delay: 0.2s; }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }

        .btn {
            background: linear-gradient(180deg, #ff6b6b 0%, #c0392b 100%);
            border: 4px solid #8b0000;
            color: #fff;
            padding: 15px 40px;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.2s;
            text-shadow: 2px 2px #000;
        }

        .btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(255, 107, 107, 0.6);
        }

        .instructions {
            color: #87ceeb;
            font-size: 8px;
            text-align: center;
            margin-top: 30px;
            line-height: 2.5;
        }

        .instructions span {
            color: #ffd700;
        }

        #hud {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #111;
            border-radius: 5px 5px 0 0;
            margin-bottom: -5px;
        }

        .hud-item {
            color: #fff;
            font-size: 12px;
        }

        .hud-item span {
            color: #ffd700;
        }

        #levelBanner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            border: 4px solid #ffd700;
            padding: 30px 50px;
            border-radius: 10px;
            z-index: 15;
            text-align: center;
        }

        #levelBanner h2 {
            color: #ffd700;
            font-size: 20px;
            margin-bottom: 10px;
        }

        #levelBanner p {
            color: #87ceeb;
            font-size: 10px;
        }

        .power-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .power-item {
            text-align: center;
            font-size: 8px;
            color: #aaa;
        }

        .power-item .icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        #gameOverScreen h1 {
            color: #ff0000;
            text-shadow: 4px 4px #8b0000;
        }

        #victoryScreen h1 {
            animation: rainbow 2s infinite;
        }

        @keyframes rainbow {
            0% { color: #ff6b6b; }
            33% { color: #4ecdc4; }
            66% { color: #ffe66d; }
            100% { color: #ff6b6b; }
        }

        .final-score {
            color: #ffd700;
            font-size: 16px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="hud">
            <div class="hud-item">üéÅ <span id="score">0</span></div>
            <div class="hud-item">‚ù§Ô∏è <span id="lives">3</span></div>
            <div class="hud-item">‚≠ê NIVEL <span id="level">1</span></div>
            <div class="hud-item">üèÜ HI: <span id="highScore">0</span></div>
        </div>
        <canvas id="gameCanvas" width="560" height="620"></canvas>

        <div id="startScreen">
            <h1>üéÑ LEO vs<br>LOS REYES MAGOS üëë</h1>
            <h2>¬°Estilo Pacman!</h2>

            <div class="kings-preview">
                <div class="king-icon"></div>
                <div class="king-icon"></div>
                <div class="king-icon"></div>
            </div>

            <div class="power-info">
                <div class="power-item">
                    <div class="icon">üéÅ</div>
                    <div>Regalos<br>+10 pts</div>
                </div>
                <div class="power-item">
                    <div class="icon">‚≠ê</div>
                    <div>Estrella<br>+50 pts</div>
                </div>
                <div class="power-item">
                    <div class="icon">‚ö´</div>
                    <div>Carb√≥n<br>¬°Asustar!</div>
                </div>
                <div class="power-item">
                    <div class="icon">ü•Ø</div>
                    <div>Rosc√≥n<br>+100 pts</div>
                </div>
                <div class="power-item">
                    <div class="icon">üê™</div>
                    <div>Camello<br>+200 pts</div>
                </div>
                <div class="power-item">
                    <div class="icon">üëü</div>
                    <div>Zapato<br>+Regalos</div>
                </div>
            </div>

            <button class="btn" onclick="startGame()">üëë ¬°JUGAR! üëë</button>

            <div class="instructions">
                <span>‚Üê ‚Üí ‚Üë ‚Üì</span> √≥ <span>WASD</span> = MOVER<br>
                Recoge todos los <span>REGALOS</span> sin que te pillen<br>
                ¬°El <span>CARB√ìN</span> asusta a los Reyes!
            </div>
        </div>

        <div id="levelBanner">
            <h2>üéÑ NIVEL <span id="levelNum">1</span> üéÑ</h2>
            <p>¬°Los Reyes Magos vienen m√°s r√°pido!</p>
        </div>

        <div id="gameOverScreen">
            <h1>üíÄ ¬°TE PILLARON! üíÄ</h1>
            <h2>Los Reyes Magos te atraparon</h2>
            <div class="final-score">Puntuaci√≥n: <span id="finalScore">0</span></div>
            <button class="btn" onclick="restartGame()">üîÑ REINTENTAR</button>
        </div>

        <div id="victoryScreen">
            <h1>üéâ ¬°VICTORIA! üéâ</h1>
            <h2>¬°Leo escap√≥ con todos los regalos!</h2>
            <div class="final-score">Puntuaci√≥n Final: <span id="victoryScore">0</span></div>
            <button class="btn" onclick="restartGame()">üéÆ JUGAR DE NUEVO</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const TILE_SIZE = 28;
        const COLS = 20;
        const ROWS = 22;

        // Estado del juego
        let gameState = 'menu';
        let score = 0;
        let lives = 3;
        let level = 1;
        let highScore = localStorage.getItem('leoKingsHighScore') || 0;
        document.getElementById('highScore').textContent = highScore;

        // Audio
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            switch(type) {
                case 'dot':
                    osc.frequency.setValueAtTime(440, audioCtx.currentTime);
                    osc.frequency.setValueAtTime(880, audioCtx.currentTime + 0.05);
                    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.1);
                    break;
                case 'power':
                    osc.type = 'square';
                    [523, 659, 784, 1047].forEach((f, i) => {
                        osc.frequency.setValueAtTime(f, audioCtx.currentTime + i * 0.08);
                    });
                    gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.4);
                    break;
                case 'death':
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.5);
                    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.5);
                    break;
                case 'eatGhost':
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.2);
                    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.3);
                    break;
            }
        }

        // Mapa: 0=vac√≠o, 1=muro, 2=regalo, 3=carb√≥n(power), 4=portal
        const mapTemplate = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,1],
            [1,2,1,1,2,1,1,1,2,1,1,2,1,1,1,2,1,1,2,1],
            [1,3,1,1,2,1,1,1,2,1,1,2,1,1,1,2,1,1,3,1],
            [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
            [1,2,1,1,2,1,2,1,1,1,1,1,1,2,1,2,1,1,2,1],
            [1,2,2,2,2,1,2,2,2,1,1,2,2,2,1,2,2,2,2,1],
            [1,1,1,1,2,1,1,1,0,1,1,0,1,1,1,2,1,1,1,1],
            [0,0,0,1,2,1,0,0,0,0,0,0,0,0,1,2,1,0,0,0],
            [1,1,1,1,2,1,0,1,1,0,0,1,1,0,1,2,1,1,1,1],
            [4,0,0,0,2,0,0,1,0,0,0,0,1,0,0,2,0,0,0,4],
            [1,1,1,1,2,1,0,1,1,1,1,1,1,0,1,2,1,1,1,1],
            [0,0,0,1,2,1,0,0,0,0,0,0,0,0,1,2,1,0,0,0],
            [1,1,1,1,2,1,0,1,1,1,1,1,1,0,1,2,1,1,1,1],
            [1,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,1],
            [1,2,1,1,2,1,1,1,2,1,1,2,1,1,1,2,1,1,2,1],
            [1,3,2,1,2,2,2,2,2,2,2,2,2,2,2,2,1,2,3,1],
            [1,1,2,1,2,1,2,1,1,1,1,1,1,2,1,2,1,2,1,1],
            [1,2,2,2,2,1,2,2,2,1,1,2,2,2,1,2,2,2,2,1],
            [1,2,1,1,1,1,1,1,2,1,1,2,1,1,1,1,1,1,2,1],
            [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];

        let map = [];
        let totalDots = 0;
        let dotsEaten = 0;

        // Leo (jugador)
        const leo = {
            x: 10,
            y: 16,
            targetX: 10,
            targetY: 16,
            direction: 'right',
            nextDirection: null,
            mouthOpen: 0,
            speed: 0.12
        };

        // Reyes Magos (fantasmas)
        const kings = [
            { name: 'Melchor', color: '#ff6b6b', x: 9, y: 10, targetX: 9, targetY: 10, direction: 'left', scared: false, eaten: false, speed: 0.08 },
            { name: 'Gaspar', color: '#4ecdc4', x: 10, y: 10, targetX: 10, targetY: 10, direction: 'up', scared: false, eaten: false, speed: 0.08 },
            { name: 'Baltasar', color: '#ffe66d', x: 10, y: 9, targetX: 10, targetY: 9, direction: 'right', scared: false, eaten: false, speed: 0.08 }
        ];

        let powerMode = false;
        let powerTimer = 0;
        let ghostEatBonus = 200;

        // Bonus items
        let bonusItem = null;
        let bonusTimer = 0;
        const bonusTypes = ['ü•Ø', 'üê™', '‚≠ê', 'üëü', 'üåü'];

        // Controles
        const keys = {};
        document.addEventListener('keydown', e => {
            keys[e.code] = true;
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Space'].includes(e.code)) {
                e.preventDefault();
            }

            if (gameState === 'playing') {
                if (e.code === 'ArrowUp' || e.code === 'KeyW') leo.nextDirection = 'up';
                if (e.code === 'ArrowDown' || e.code === 'KeyS') leo.nextDirection = 'down';
                if (e.code === 'ArrowLeft' || e.code === 'KeyA') leo.nextDirection = 'left';
                if (e.code === 'ArrowRight' || e.code === 'KeyD') leo.nextDirection = 'right';
            }
        });
        document.addEventListener('keyup', e => keys[e.code] = false);

        function initMap() {
            map = [];
            totalDots = 0;
            dotsEaten = 0;

            for (let y = 0; y < ROWS; y++) {
                map[y] = [];
                for (let x = 0; x < COLS; x++) {
                    map[y][x] = mapTemplate[y][x];
                    if (map[y][x] === 2 || map[y][x] === 3) {
                        totalDots++;
                    }
                }
            }
        }

        function resetPositions() {
            leo.x = 10; leo.y = 16;
            leo.targetX = 10; leo.targetY = 16;
            leo.direction = 'right';
            leo.nextDirection = null;

            kings[0].x = 9; kings[0].y = 10; kings[0].targetX = 9; kings[0].targetY = 10;
            kings[1].x = 10; kings[1].y = 10; kings[1].targetX = 10; kings[1].targetY = 10;
            kings[2].x = 10; kings[2].y = 9; kings[2].targetX = 10; kings[2].targetY = 9;

            kings.forEach(k => {
                k.scared = false;
                k.eaten = false;
            });
            powerMode = false;
        }

        // ===================== DIBUJAR =====================
        function drawMap() {
            for (let y = 0; y < ROWS; y++) {
                for (let x = 0; x < COLS; x++) {
                    const tile = map[y][x];
                    const px = x * TILE_SIZE;
                    const py = y * TILE_SIZE;

                    if (tile === 1) {
                        // Muro - estilo navide√±o
                        ctx.fillStyle = '#1a4a1a';
                        ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);

                        // Borde brillante
                        ctx.strokeStyle = '#2d8a2d';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(px + 1, py + 1, TILE_SIZE - 2, TILE_SIZE - 2);

                        // Decoraci√≥n de luces navide√±as ocasionales
                        if ((x + y) % 7 === 0) {
                            const colors = ['#ff0000', '#ffd700', '#00ff00', '#0088ff'];
                            ctx.fillStyle = colors[(x + y) % 4];
                            ctx.beginPath();
                            ctx.arc(px + TILE_SIZE/2, py + TILE_SIZE/2, 4, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    } else if (tile === 2) {
                        // Regalo (punto)
                        const bounce = Math.sin(Date.now() / 200 + x + y) * 2;
                        ctx.fillStyle = '#ffd700';
                        ctx.beginPath();
                        ctx.arc(px + TILE_SIZE/2, py + TILE_SIZE/2 + bounce, 5, 0, Math.PI * 2);
                        ctx.fill();

                        // Lazo
                        ctx.fillStyle = '#ff0000';
                        ctx.fillRect(px + TILE_SIZE/2 - 1, py + TILE_SIZE/2 - 6 + bounce, 2, 4);
                    } else if (tile === 3) {
                        // Carb√≥n (power pellet)
                        const pulse = 0.8 + Math.sin(Date.now() / 150) * 0.2;
                        ctx.fillStyle = '#333';
                        ctx.beginPath();
                        ctx.arc(px + TILE_SIZE/2, py + TILE_SIZE/2, 10 * pulse, 0, Math.PI * 2);
                        ctx.fill();

                        // Brillo
                        ctx.fillStyle = 'rgba(255, 100, 100, 0.5)';
                        ctx.beginPath();
                        ctx.arc(px + TILE_SIZE/2 - 3, py + TILE_SIZE/2 - 3, 4 * pulse, 0, Math.PI * 2);
                        ctx.fill();

                        // Emoji
                        ctx.font = '14px Arial';
                        ctx.fillText('ite', px + 5, py + 20);
                    }
                }
            }
        }

        function drawLeo() {
            const px = leo.x * TILE_SIZE + TILE_SIZE / 2;
            const py = leo.y * TILE_SIZE + TILE_SIZE / 2;

            ctx.save();
            ctx.translate(px, py);

            // Rotaci√≥n seg√∫n direcci√≥n
            let rotation = 0;
            if (leo.direction === 'right') rotation = 0;
            if (leo.direction === 'down') rotation = Math.PI / 2;
            if (leo.direction === 'left') rotation = Math.PI;
            if (leo.direction === 'up') rotation = -Math.PI / 2;
            ctx.rotate(rotation);

            // Animaci√≥n de boca
            leo.mouthOpen += 0.3;
            const mouthAngle = Math.abs(Math.sin(leo.mouthOpen)) * 0.5;

            // Cuerpo de Leo (amarillo estilo Pacman pero con cara)
            ctx.fillStyle = '#fcd34d';
            ctx.beginPath();
            ctx.arc(0, 0, 12, mouthAngle, Math.PI * 2 - mouthAngle);
            ctx.lineTo(0, 0);
            ctx.closePath();
            ctx.fill();

            // Ojo
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(-2, -6, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(-1, -7, 1, 0, Math.PI * 2);
            ctx.fill();

            // Pelo de Leo
            ctx.fillStyle = '#78350f';
            ctx.beginPath();
            ctx.arc(0, -8, 6, Math.PI, 0, false);
            ctx.fill();

            ctx.restore();

            // Efecto de power mode
            if (powerMode) {
                ctx.strokeStyle = `rgba(255, 215, 0, ${0.5 + Math.sin(Date.now() / 100) * 0.3})`;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(px, py, 16, 0, Math.PI * 2);
                ctx.stroke();
            }
        }

        function drawKing(king) {
            const px = king.x * TILE_SIZE + TILE_SIZE / 2;
            const py = king.y * TILE_SIZE + TILE_SIZE / 2;

            ctx.save();
            ctx.translate(px, py);

            if (king.eaten) {
                // Solo ojos volviendo a casa
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.ellipse(-5, -2, 4, 5, 0, 0, Math.PI * 2);
                ctx.ellipse(5, -2, 4, 5, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#00f';
                ctx.beginPath();
                ctx.arc(-5, -1, 2, 0, Math.PI * 2);
                ctx.arc(5, -1, 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
                return;
            }

            const wobble = Math.sin(Date.now() / 100 + king.x) * 2;

            // Cuerpo del Rey
            if (king.scared) {
                // Asustado - azul oscuro
                ctx.fillStyle = powerTimer < 100 && Math.floor(Date.now() / 100) % 2 ? '#fff' : '#2244aa';
            } else {
                ctx.fillStyle = king.color;
            }

            // Forma de fantasma
            ctx.beginPath();
            ctx.arc(0, -4 + wobble, 12, Math.PI, 0, false);
            ctx.lineTo(12, 10 + wobble);
            // Ondas en la parte inferior
            for (let i = 0; i < 4; i++) {
                const wx = 12 - i * 6;
                const wy = i % 2 ? 10 : 14;
                ctx.lineTo(wx, wy + wobble);
            }
            ctx.lineTo(-12, 10 + wobble);
            ctx.closePath();
            ctx.fill();

            // Corona
            if (!king.scared) {
                ctx.fillStyle = '#ffd700';
                ctx.beginPath();
                ctx.moveTo(-8, -14 + wobble);
                ctx.lineTo(-6, -8 + wobble);
                ctx.lineTo(-3, -12 + wobble);
                ctx.lineTo(0, -6 + wobble);
                ctx.lineTo(3, -12 + wobble);
                ctx.lineTo(6, -8 + wobble);
                ctx.lineTo(8, -14 + wobble);
                ctx.lineTo(8, -8 + wobble);
                ctx.lineTo(-8, -8 + wobble);
                ctx.closePath();
                ctx.fill();

                // Joyas en la corona
                ctx.fillStyle = king.name === 'Melchor' ? '#ff0000' : king.name === 'Gaspar' ? '#00ff00' : '#0088ff';
                ctx.beginPath();
                ctx.arc(0, -10 + wobble, 2, 0, Math.PI * 2);
                ctx.fill();
            }

            // Ojos
            if (king.scared) {
                // Ojos asustados
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(-5, -2 + wobble, 4, 0, Math.PI * 2);
                ctx.arc(5, -2 + wobble, 4, 0, Math.PI * 2);
                ctx.fill();

                // Boca asustada
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(-5, 5 + wobble);
                ctx.lineTo(-3, 3 + wobble);
                ctx.lineTo(0, 5 + wobble);
                ctx.lineTo(3, 3 + wobble);
                ctx.lineTo(5, 5 + wobble);
                ctx.stroke();
            } else {
                // Ojos normales
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.ellipse(-5, -2 + wobble, 4, 5, 0, 0, Math.PI * 2);
                ctx.ellipse(5, -2 + wobble, 4, 5, 0, 0, Math.PI * 2);
                ctx.fill();

                // Pupilas (miran hacia Leo)
                const dx = leo.x - king.x;
                const dy = leo.y - king.y;
                const angle = Math.atan2(dy, dx);
                const pupilDist = 2;

                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(-5 + Math.cos(angle) * pupilDist, -2 + Math.sin(angle) * pupilDist + wobble, 2, 0, Math.PI * 2);
                ctx.arc(5 + Math.cos(angle) * pupilDist, -2 + Math.sin(angle) * pupilDist + wobble, 2, 0, Math.PI * 2);
                ctx.fill();

                // Barba seg√∫n el rey
                if (king.name === 'Melchor') {
                    ctx.fillStyle = '#fff';
                    ctx.beginPath();
                    ctx.moveTo(-6, 4 + wobble);
                    ctx.quadraticCurveTo(0, 12 + wobble, 6, 4 + wobble);
                    ctx.fill();
                } else if (king.name === 'Gaspar') {
                    ctx.fillStyle = '#8b4513';
                    ctx.beginPath();
                    ctx.moveTo(-4, 4 + wobble);
                    ctx.quadraticCurveTo(0, 10 + wobble, 4, 4 + wobble);
                    ctx.fill();
                }
                // Baltasar sin barba
            }

            ctx.restore();
        }

        function drawBonus() {
            if (!bonusItem) return;

            const px = bonusItem.x * TILE_SIZE + TILE_SIZE / 2;
            const py = bonusItem.y * TILE_SIZE + TILE_SIZE / 2;
            const bounce = Math.sin(Date.now() / 150) * 5;

            // Brillo de fondo
            ctx.fillStyle = `rgba(255, 215, 0, ${0.3 + Math.sin(Date.now() / 200) * 0.2})`;
            ctx.beginPath();
            ctx.arc(px, py + bounce, 18, 0, Math.PI * 2);
            ctx.fill();

            ctx.font = '22px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(bonusItem.type, px, py + bounce);
        }

        // ===================== L√ìGICA =====================
        function canMove(x, y) {
            const tileX = Math.floor(x);
            const tileY = Math.floor(y);

            // Portal (t√∫neles)
            if (tileX < 0) return true;
            if (tileX >= COLS) return true;
            if (tileY < 0 || tileY >= ROWS) return false;

            return map[tileY][tileX] !== 1;
        }

        function updateLeo() {
            // Verificar si puede cambiar direcci√≥n
            if (leo.nextDirection) {
                let testX = Math.round(leo.x);
                let testY = Math.round(leo.y);

                switch(leo.nextDirection) {
                    case 'up': testY--; break;
                    case 'down': testY++; break;
                    case 'left': testX--; break;
                    case 'right': testX++; break;
                }

                if (canMove(testX, testY)) {
                    leo.direction = leo.nextDirection;
                    leo.nextDirection = null;
                }
            }

            // Mover en la direcci√≥n actual
            let newX = leo.x;
            let newY = leo.y;

            switch(leo.direction) {
                case 'up': newY -= leo.speed; break;
                case 'down': newY += leo.speed; break;
                case 'left': newX -= leo.speed; break;
                case 'right': newX += leo.speed; break;
            }

            // Verificar colisi√≥n antes de mover
            const nextTileX = Math.round(newX);
            const nextTileY = Math.round(newY);

            if (canMove(nextTileX, nextTileY)) {
                leo.x = newX;
                leo.y = newY;
            }

            // Portal (t√∫neles laterales)
            if (leo.x < -0.5) leo.x = COLS - 0.5;
            if (leo.x > COLS - 0.5) leo.x = -0.5;

            // Recoger items
            const tileX = Math.round(leo.x);
            const tileY = Math.round(leo.y);

            if (tileX >= 0 && tileX < COLS && tileY >= 0 && tileY < ROWS) {
                const tile = map[tileY][tileX];

                if (tile === 2) {
                    // Regalo
                    map[tileY][tileX] = 0;
                    score += 10;
                    dotsEaten++;
                    playSound('dot');
                } else if (tile === 3) {
                    // Carb√≥n - power mode!
                    map[tileY][tileX] = 0;
                    score += 50;
                    dotsEaten++;
                    powerMode = true;
                    powerTimer = 400;
                    ghostEatBonus = 200;
                    kings.forEach(k => k.scared = true);
                    playSound('power');
                }
            }

            // Bonus item
            if (bonusItem) {
                const dx = leo.x - bonusItem.x;
                const dy = leo.y - bonusItem.y;
                if (Math.sqrt(dx*dx + dy*dy) < 1) {
                    score += bonusItem.points;
                    playSound('power');
                    bonusItem = null;
                }
            }

            updateHUD();

            // Verificar victoria
            if (dotsEaten >= totalDots) {
                nextLevel();
            }
        }

        function updateKings() {
            kings.forEach(king => {
                // Velocidad
                let speed = king.speed + (level - 1) * 0.01;
                if (king.scared) speed *= 0.5;
                if (king.eaten) speed *= 2;

                // Moverse hacia el target
                const dx = king.targetX - king.x;
                const dy = king.targetY - king.y;

                if (Math.abs(dx) > 0.05) {
                    king.x += Math.sign(dx) * speed;
                }
                if (Math.abs(dy) > 0.05) {
                    king.y += Math.sign(dy) * speed;
                }

                // Lleg√≥ al target, elegir nueva direcci√≥n
                if (Math.abs(dx) < 0.1 && Math.abs(dy) < 0.1) {
                    king.x = king.targetX;
                    king.y = king.targetY;

                    // Si fue comido y lleg√≥ a casa, revivir
                    if (king.eaten && king.x >= 9 && king.x <= 11 && king.y >= 9 && king.y <= 10) {
                        king.eaten = false;
                        king.scared = powerMode;
                    }

                    // Elegir nueva direcci√≥n
                    const directions = [];
                    if (canMove(king.x, king.y - 1) && king.direction !== 'down') directions.push('up');
                    if (canMove(king.x, king.y + 1) && king.direction !== 'up') directions.push('down');
                    if (canMove(king.x - 1, king.y) && king.direction !== 'right') directions.push('left');
                    if (canMove(king.x + 1, king.y) && king.direction !== 'left') directions.push('right');

                    if (directions.length > 0) {
                        // Si est√° asustado, huir de Leo
                        if (king.scared && !king.eaten) {
                            let bestDir = directions[0];
                            let bestDist = 0;
                            directions.forEach(dir => {
                                let testX = king.x, testY = king.y;
                                if (dir === 'up') testY--;
                                if (dir === 'down') testY++;
                                if (dir === 'left') testX--;
                                if (dir === 'right') testX++;
                                const dist = Math.sqrt((testX - leo.x) ** 2 + (testY - leo.y) ** 2);
                                if (dist > bestDist) {
                                    bestDist = dist;
                                    bestDir = dir;
                                }
                            });
                            king.direction = bestDir;
                        }
                        // Si fue comido, ir a casa
                        else if (king.eaten) {
                            let bestDir = directions[0];
                            let bestDist = Infinity;
                            directions.forEach(dir => {
                                let testX = king.x, testY = king.y;
                                if (dir === 'up') testY--;
                                if (dir === 'down') testY++;
                                if (dir === 'left') testX--;
                                if (dir === 'right') testX++;
                                const dist = Math.sqrt((testX - 10) ** 2 + (testY - 10) ** 2);
                                if (dist < bestDist) {
                                    bestDist = dist;
                                    bestDir = dir;
                                }
                            });
                            king.direction = bestDir;
                        }
                        // Normal: perseguir a Leo (con algo de aleatoriedad)
                        else {
                            if (Math.random() < 0.7) {
                                let bestDir = directions[0];
                                let bestDist = Infinity;
                                directions.forEach(dir => {
                                    let testX = king.x, testY = king.y;
                                    if (dir === 'up') testY--;
                                    if (dir === 'down') testY++;
                                    if (dir === 'left') testX--;
                                    if (dir === 'right') testX++;
                                    const dist = Math.sqrt((testX - leo.x) ** 2 + (testY - leo.y) ** 2);
                                    if (dist < bestDist) {
                                        bestDist = dist;
                                        bestDir = dir;
                                    }
                                });
                                king.direction = bestDir;
                            } else {
                                king.direction = directions[Math.floor(Math.random() * directions.length)];
                            }
                        }

                        // Actualizar target
                        king.targetX = king.x;
                        king.targetY = king.y;
                        if (king.direction === 'up') king.targetY--;
                        if (king.direction === 'down') king.targetY++;
                        if (king.direction === 'left') king.targetX--;
                        if (king.direction === 'right') king.targetX++;

                        // Portal
                        if (king.targetX < 0) king.targetX = COLS - 1;
                        if (king.targetX >= COLS) king.targetX = 0;
                    }
                }

                // Colisi√≥n con Leo
                if (!king.eaten) {
                    const distToLeo = Math.sqrt((king.x - leo.x) ** 2 + (king.y - leo.y) ** 2);
                    if (distToLeo < 0.8) {
                        if (king.scared) {
                            // ¬°Comerse al Rey!
                            king.eaten = true;
                            king.scared = false;
                            score += ghostEatBonus;
                            ghostEatBonus *= 2;
                            playSound('eatGhost');
                        } else {
                            // ¬°Leo atrapado!
                            loseLife();
                        }
                    }
                }
            });

            // Power mode timer
            if (powerMode) {
                powerTimer--;
                if (powerTimer <= 0) {
                    powerMode = false;
                    kings.forEach(k => {
                        if (!k.eaten) k.scared = false;
                    });
                }
            }
        }

        function updateBonus() {
            bonusTimer++;

            // Aparecer bonus ocasionalmente
            if (!bonusItem && bonusTimer > 500 && Math.random() < 0.005) {
                bonusItem = {
                    x: 10,
                    y: 13,
                    type: bonusTypes[Math.floor(Math.random() * bonusTypes.length)],
                    points: [100, 200, 300, 150, 500][Math.floor(Math.random() * 5)]
                };
            }

            // Desaparecer despu√©s de un tiempo
            if (bonusItem && bonusTimer > 800) {
                bonusItem = null;
                bonusTimer = 0;
            }
        }

        function loseLife() {
            lives--;
            playSound('death');

            if (lives <= 0) {
                gameOver();
            } else {
                resetPositions();
                updateHUD();
            }
        }

        function nextLevel() {
            level++;
            if (level > 5) {
                victory();
                return;
            }

            // Mostrar banner de nivel
            document.getElementById('levelBanner').style.display = 'block';
            document.getElementById('levelNum').textContent = level;

            setTimeout(() => {
                document.getElementById('levelBanner').style.display = 'none';
                initMap();
                resetPositions();

                // Aumentar velocidad de los Reyes
                kings.forEach(k => {
                    k.speed = 0.08 + level * 0.015;
                });

                updateHUD();
            }, 2000);
        }

        function updateHUD() {
            document.getElementById('score').textContent = score;
            document.getElementById('lives').textContent = lives;
            document.getElementById('level').textContent = level;

            if (score > highScore) {
                highScore = score;
                localStorage.setItem('leoKingsHighScore', highScore);
                document.getElementById('highScore').textContent = highScore;
            }
        }

        function gameOver() {
            gameState = 'gameover';
            document.getElementById('finalScore').textContent = score;
            document.getElementById('gameOverScreen').style.display = 'flex';
        }

        function victory() {
            gameState = 'victory';
            document.getElementById('victoryScore').textContent = score;
            document.getElementById('victoryScreen').style.display = 'flex';
        }

        function startGame() {
            initAudio();
            document.getElementById('startScreen').style.display = 'none';

            score = 0;
            lives = 3;
            level = 1;
            bonusTimer = 0;
            bonusItem = null;

            initMap();
            resetPositions();

            kings.forEach(k => {
                k.speed = 0.08;
            });

            updateHUD();
            gameState = 'playing';
            gameLoop();
        }

        function restartGame() {
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('victoryScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
            gameState = 'menu';
        }

        // ===================== GAME LOOP =====================
        function gameLoop() {
            if (gameState !== 'playing') return;

            // Clear
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Update
            updateLeo();
            updateKings();
            updateBonus();

            // Draw
            drawMap();
            drawBonus();
            kings.forEach(drawKing);
            drawLeo();

            requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>
